<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RFQ WS Test</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; }
    .log { white-space: pre-wrap; background: #111; color: #0f0; padding: 12px; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>WebSocket Test (Centrifugo)</h2>
  <p>Subscribing to channel: <code>category:1</code></p>
  <p>Status: <span id="status">connecting...</span></p>

  <h3>Messages</h3>
  <div id="log" class="log"></div>

  <script>
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    function log(msg) {
      logEl.textContent += msg + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    // Centrifugo websocket endpoint
    const wsUrl = "ws://localhost:8000/connection/websocket";

    // We use unauthenticated connection for dev test
    const ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      statusEl.textContent = "connected";
      log("[open] connected to " + wsUrl);

      // 1) Send connect command (no token)
      ws.send(JSON.stringify({
        id: 1,
        method: "connect",
        params: {}
      }));
    };

    ws.onmessage = (event) => {
      const msg = event.data;
      log("[message] " + msg);

      let obj = null;
      try { obj = JSON.parse(msg); } catch (e) {}

      // After connect response, subscribe to channel
      if (obj && obj.id === 1 && obj.result) {
        ws.send(JSON.stringify({
          id: 2,
          method: "subscribe",
          params: { channel: "category:1" }
        }));
      }

      // Subscribe response
      if (obj && obj.id === 2 && obj.result) {
        log("[subscribed] category:1 âœ…");
      }
    };

    ws.onerror = (e) => {
      statusEl.textContent = "error";
      log("[error] " + (e.message || "ws error"));
    };

    ws.onclose = () => {
      statusEl.textContent = "closed";
      log("[close] disconnected");
    };
  </script>
</body>
</html>
